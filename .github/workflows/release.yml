name: Release
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'What to release'
        required: true
        default: 'both'
        type: choice
        options:
          - nuget
          - docs
          - both
      version:
        description: 'Version (required for NuGet, e.g., 1.2.3)'
        required: false
        type: string

jobs:
  build:
    if: github.event_name == 'release' || github.event.inputs.release_type == 'nuget' || github.event.inputs.release_type == 'both'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.x
    
    - name: Extract version from tag
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build -c Release --no-restore -p:Version=${{ steps.get_version.outputs.VERSION }}
    
    - name: Pack all SDK packages
      run: dotnet pack -c Release --no-build -p:Version=${{ steps.get_version.outputs.VERSION }} -o _build/nuget
    
    - uses: actions/upload-artifact@v4
      with:
        name: nuget
        path: _build/nuget

  publish:
    if: github.event_name == 'release' || github.event.inputs.release_type == 'nuget' || github.event.inputs.release_type == 'both'
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.x
      
      - uses: actions/download-artifact@v4
        with:
          name: nuget
          path: _build/nuget
      
      - name: Extract version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Publish NuGet packages
        run: |
          dotnet nuget push "_build/nuget/*.nupkg" --api-key "${{ secrets.NUGET_KEY }}" --skip-duplicate --source https://api.nuget.org/v3/index.json
      
      - name: Upload packages to GitHub release
        if: github.event_name == 'release'
        run: |
          gh release upload --repo xping-dev/sdk-dotnet ${GITHUB_REF_NAME} _build/nuget/Xping.Sdk.Core.${{ steps.get_version.outputs.VERSION }}.nupkg
          gh release upload --repo xping-dev/sdk-dotnet ${GITHUB_REF_NAME} _build/nuget/Xping.Sdk.NUnit.${{ steps.get_version.outputs.VERSION }}.nupkg
          gh release upload --repo xping-dev/sdk-dotnet ${GITHUB_REF_NAME} _build/nuget/Xping.Sdk.XUnit.${{ steps.get_version.outputs.VERSION }}.nupkg
          gh release upload --repo xping-dev/sdk-dotnet ${GITHUB_REF_NAME} _build/nuget/Xping.Sdk.MSTest.${{ steps.get_version.outputs.VERSION }}.nupkg
        env:
          GH_TOKEN: ${{ github.token }}

  publish-docs:
    if: github.event_name == 'release' || github.event.inputs.release_type == 'docs' || github.event.inputs.release_type == 'both'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    # Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
    permissions:
      actions: read
      pages: write
      id-token: write
    # Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
    # However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
    concurrency:
      group: "pages"
      cancel-in-progress: false
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Dotnet Setup
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.x
    - run: dotnet tool update -g docfx
    - run: docfx ./docs/docfx.json  
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs/_site'
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
